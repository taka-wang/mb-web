machine:
    #timezone:
    #    Asia/Taipei
    services:
        - docker

dependencies:
    override:
        - sudo apt-get install python-dev && sudo pip install --upgrade docker-compose==1.8.0

test:
    pre:
        - docker version
        - docker-compose version
        #- docker build --no-cache=true -t conf -f conf/Dockerfile.x86 .
        #- docker build --no-cache=true -t worker -f worker/Dockerfile.x86 .
        #- docker build --no-cache=true -t test    -f test/Dockerfile.x86 .
    override:
        #- docker run -it conf
        #- docker run -it worker
        #- docker run -it test
        - docker build --no-cache=true -t edgepro/mb-web:x86 -f Dockerfile.x86 .
        #- docker-compose -f docker-compose.x86 build --no-cache
        - docker-compose -f docker-compose.x86 up -d
        - sleep 20
        - ./test.sh
        - docker-compose -f docker-compose.x86 stop
        #----------------------CI------------------------------------
        #- docker-compose -f test/docker-compose.x86 rm -f -a
        - docker-compose -f test/docker-compose.x86 build
        - docker-compose -f test/docker-compose.x86 up --abort-on-container-exit
        - cat /var/tmp/success      # test
        #- rm -f /var/tmp/success   # drone only
    #post:

# publish to dockerhub
deployment:
    hub:
        branch: master
        commands:
            - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
            - docker tag edgepro/mb-web:x86 edgepro/mb-web:latest
            - docker push edgepro/mb-web:latest
            - docker push edgepro/mb-web:x86